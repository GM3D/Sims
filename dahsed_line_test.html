<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Dashed line moving along with mouse pointer</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
        <!-- <p id="info">window_size (x, y), point position (x, y), w position (x, y)</p> -->
		<script src="js/three.js"></script>
		<script>
         "use strict";
         var mouse;
         var scene, camera, renderer;
         var point, ppos;
         var x, y;
         var point0, point1;
         var line, line_geom, line_mat;
         var line2, line_geom2, line_mat2;

         var width = window.innerWidth;
         var height = window.innerHeight;
         var aspect = height / width;
         var r = 5.0;
         init();
         animate();

         function init(){
             mouse = new THREE.Vector2(0, 0);
             ppos = new THREE.Vector3(0, 0, 0);
             point0 = new THREE.Vector3(0, 0, 0);
             point1 = new THREE.Vector3(2, 0, 0);
             x = y = 0;
             console.log("ppos:1 = " + ppos.x + ", " + ppos.y + 
                         ", " + ppos.z);
             renderer = new THREE.WebGLRenderer();
             renderer.setSize(width, height);
             document.addEventListener('mousemove', 
                                       onDocumentMouseMove, false);
             document.body.appendChild(renderer.domElement);
             scene = new THREE.Scene();
             setup_scene();

             camera = new 
             THREE.OrthographicCamera(-r, r,
                                      r * aspect, -r * aspect,
                                      1, 1000);

             camera.position.z = 5;
             scene.add(camera);
             console.log("end of initialization.");
         }

         function setup_scene(){
             var plane_geometry = new THREE.PlaneGeometry(4, 4);
             var mat_ivory = new THREE.MeshBasicMaterial({color: 0xffffdd});
             var plane = new THREE.Mesh(plane_geometry, mat_ivory);
             scene.add(plane);

             var point_geom = new THREE.CircleGeometry(0.05, 16);
             var mat_black = new THREE.MeshBasicMaterial({color: 0x000000});
             point = new THREE.Mesh(point_geom, mat_black);
             scene.add(point);

             line_geom = new THREE.Geometry();
             line_geom.dynamic = true;
             line_geom.vertices.push(point0);
             line_geom.vertices.push(ppos);
             line_geom.computeLineDistances();
             line_mat = new THREE.LineDashedMaterial(
                 {color: 0x8888FF, dashSize: 0.05, gapSize: 0.02});
             /* line_mat.dynamic = true;*/
             line = new THREE.Line(line_geom, line_mat);
             scene.add(line);
             console.log("ppos:2 = " + ppos.x + ", " + ppos.y + 
                         ", " + ppos.z);

             line_geom2 = new THREE.Geometry();
             line_geom2.vertices.push(point0);
             line_geom2.vertices.push(point1);
             line_geom2.computeLineDistances();
             line_mat2 = new THREE.LineDashedMaterial(
                 {color: 0x108810, dashSize: 0.05, gapSize: 0.02});
             line2 = new THREE.Line(line_geom2, line_mat2);
             scene.add(line2);
         }

         function onDocumentMouseMove(event){
             mouse.set(event.clientX, event.clientY);
             x = event.clientX;
             y = event.clientY;
             console.log("ppos:3 = " + ppos.x + ", " + ppos.y + 
                         ", " + ppos.z);
             console.log("(x, y):3 = " + x + ", " + y);

			 ppos.setX(r * ((mouse.x / width) * 2 - 1));
			 ppos.setY(r * (-(mouse.y - height / 2) / width) * 2);

			 x = (r * ((mouse.x / width) * 2 - 1));
			 y = (r * (-(mouse.y - height / 2) / width) * 2);

             // no idea why setting z here is required.
			 /* ppos.z = 0;*/
             console.log("ppos:4 = " + ppos.x + ", " + ppos.y + 
                         ", " + ppos.z);
             console.log("(x, y):4 = " + x + ", " + y);
             /* point.position.copy(ppos);*/
             point.position.x = x;
             point.position.y = y;
             line.geometry.vertices[1].setX(x);
             line.geometry.vertices[1].setY(y);
             line.geometry.computeLineDistances();
             line.geometry.verticesNeedUpdate = true;
             /* line.material.needsUpdate = true;*/
		 }
         
         function render(){
             renderer.setViewport(0, 0, width, height);
	         renderer.render(scene, camera);
         }

         function update(){
         }

         function animate(){
	         requestAnimationFrame(animate);
             render();
             update();
         }
		</script>
	</body>
</html>
